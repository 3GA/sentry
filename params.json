{"body":"### Sentry - dns for fun and profit!\r\n\r\nSentry is a DNS proxy that allows you to inspect, block, rewrite, redirect and resolve queries in-flight. \r\n\r\n### Installing\r\n\r\n1. Download sentry \r\n2. python setup.py install\r\n\r\n### Configuring\r\n\r\nYou should start up with a basic json config file like this: \r\n\r\n    {\r\n        \"port\" : 5300,\r\n    \t\"host\" : \"0.0.0.0\",\r\n    \t\"rules\" : [\r\n    \t\t\"resolve ^(.*) using 8.8.4.4, 8.8.8.8\"\r\n    \t]\t\r\n    }\r\n    \r\nThe example above tells sentry to: \r\n\r\n* listen on port 5300 (udp)\r\n* resolve all inbound queries using DNS servers 8.8.4.4 and 8.8.8.8 (google's public DNS servers)\r\n\r\n### Running it\r\n\r\nTo run sentry you just need to pass it the config file you created: \r\n\r\n    $ sentry -c CONFIG \r\n    [07/01/2012 06:38:28] [sentry] INFO: using config: sentry.config\r\n    [07/01/2012 06:38:28] [sentry.core] INFO: starting, 1 known rules\r\n    [07/01/2012 06:38:28] [sentry.net] INFO: Server started on 0.0.0.0:5300\r\n\r\nFor the prestige, you can use dig to verify sentry is responding to requests:\r\n\r\n    dig @localhost -p 5300 nytimes.com\r\n\r\n### Rules - doing things you never thought possible with DNS\r\n\r\nSentry allows you to log, block, rewrite, redirect and resolve queries based upon simple rules that are matched, in order, against the inbound DNS query. \r\n\r\n**Redirecting a query:**\r\n\r\nA redirect rule can redirect an inbound requests to nytimes.com to google.com with a CNAME response. \r\n\r\n    \"redirect ^(.*)nytimes.com to google.com\"\r\n    \t\t\r\nNow, for the prestige: \r\n\r\n    $ dig @localhost -p 5300 nytimes.com\r\n\r\n    ; <<>> DiG 9.7.3-P3 <<>> @localhost -p 5300 nytimes.com\r\n    ; (3 servers found)\r\n    ;; global options: +cmd\r\n    ;; Got answer:\r\n    ;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 56474\r\n    ;; flags: qr rd; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 0\r\n    ;; WARNING: recursion requested but not available\r\n\r\n    ;; QUESTION SECTION:\r\n    ;nytimes.com.\t\t\tIN\tA\r\n\r\n    ;; ANSWER SECTION:\r\n    nytimes.com.\t\t300\tIN\tCNAME\tgoogle.com.\r\n\r\n    ;; Query time: 502 msec\r\n    ;; SERVER: 127.0.0.1#5300(127.0.0.1)\r\n    ;; WHEN: Sun Jul  1 00:37:17 2012\r\n    ;; MSG SIZE  rcvd: 50\r\n\r\n**Logging a query:**\r\n\r\nA log rule tells sentry to log an inbound queries matching a certain regular expression\r\n\r\n    \"log ^(.*)google.com\"\r\n    \r\n    \r\n**Blocking a query:**\r\n\r\nA block rule tells sentry to return an empty response to all queries matching a certain regular expression \r\n\r\n    \"block ^(.*).xxx\"\r\n\r\nBlocking rules can also be conditional - **new!**\r\n\r\n    \"block ^(.*).google.com if type is MX\"\r\n\r\n\r\nA few more conditional examples:\r\n\r\n    \"block ^(.*).google.com if type is MX and class is IN\"\r\n    \"block ^(.*).google.com if class is IN\"\r\n    \r\n**Resolving a query:**\r\n\r\nA resolve rule tells sentry to return to resolve all queries matching a certain regular expression using one, or more, upstream DNS servers\r\n\r\n    \"\"resolve ^(.*)facebook.com using 10.10.1.2 \",\"\r\n    \t\t\r\n\\* If you would like your sentry server to resolve all inbound requests you must include at the bottom of your rules list a catch all entry like below: \r\n\r\n    \"resolve ^(.*) using 8.8.4.4, 8.8.8.8\"\r\n    \r\n**Here's an example of a configuration file including multiple rules:**\r\n\r\n    {\r\n    \t\"port\" : 5300,\r\n    \t\"host\" : \"0.0.0.0\",\r\n    \t\"rules\" : [\r\n    \t\t\"block ^(.*)youtube.com\",\t\t\r\n    \t\t\"block ^(.*).xxx\",\r\n    \t\t\"log ^(.*)google.com\",\r\n\r\n    \t\t\"rewrite ^www.google.com to google.com\",\t\t\r\n\r\n    \t\t\"redirect ^(.*)nytimes.com to google.com\",\t\t\t\t\t\r\n    \t\t\"redirect ^(.*)reddit.com to google.com\",\r\n\r\n    \t\t\"resolve ^(.*)facebook.com using 10.10.1.2 \",\r\n    \t\t\"resolve ^(.*) using 8.8.4.4, 8.8.8.8\"\r\n\t\t\r\n\r\n    \t]\t\r\n    }\r\n\r\n### Sentry Metrics\r\n\r\nLike metrics? Just send sentry a SIGUSR1 posix signal and bam! \r\n\r\nsending the signal (replace $PID with sentry's process id):\r\n\r\n    $ kill -30 $PID\r\n\r\noutput in the sentry log: \r\n\r\n    [07/01/2012 00:57:12] [sentry.core] INFO: system stats: \r\n    +-------------------------------------+---------------+\r\n    | metric                              | value         |\r\n    +-------------------------------------+---------------+\r\n    | net.bytes_received                  | 85            |\r\n    | net.bytes_sent                      | 458           |\r\n    | net.packets_received                | 3             |\r\n    | net.packets_sent                    | 3             |\r\n    | requests_pending                    | 0             |\r\n    | requests_total                      | 3             |\r\n    | response_time_msec_avg              | 3.07466666667 |\r\n    | response_time_msec_max              | 4.138         |\r\n    | response_time_msec_min              | 1.435         |\r\n    | uptime                              | 23.628207922  |\r\n    | <class 'sentry.rules.RedirectRule'> | 1             |\r\n    | <class 'sentry.rules.LoggingRule'>  | 2             |\r\n    | <class 'sentry.rules.ResolveRule'>  | 2             |\r\n    +-------------------------------------+---------------+\r\n    [07/01/2012 00:57:12] [sentry.core] INFO: domain stats: \r\n     +--------------+---------+\r\n    | domain       | queries |\r\n    +--------------+---------+\r\n    | google.com.  | 2       |\r\n    | nytimes.com. | 1       |\r\n    +--------------+---------+\r\n\r\n### Performance\r\n\r\nDNS is an inherently lightweight protocol (connection-less, small payload size, etc) so you should be able to handle many hundreds of connections per second in a single tight loop thread (sentry's default mode of operation).\r\n\r\nThere is however a particular case in which what I just told you is a complete lie: slow upstream servers. If you are getting responses from upstream servers greater than single digits msec you might want to consider increasing the size of Sentry's internal thread pool so more requests are outstanding at once. \r\n\r\nHere's an example of a custom thread pool size:\r\n\r\n    {\r\n        \"port\" : 5300,\r\n        \"host\" : \"0.0.0.0\",\r\n        \"threadpool_size\" : 4,\r\n        \"rules\" : [\r\n            \"block ^(.*)youtube.com if type is MX\",     \r\n            \"block ^(.*).xxx\",\r\n            \"log ^(.*)google.com\",\r\n\r\n            \"rewrite ^www.google.com to google.com\",        \r\n\r\n            \"redirect ^(.*)nytimes.com to google.com\",                  \r\n            \"redirect ^(.*)reddit.com to google.com\",\r\n\r\n            \"resolve ^(.*)facebook.com using 10.10.1.2 \",\r\n            \"resolve ^(.*) using 8.8.4.4, 8.8.8.8\"\r\n\r\n        ]   \r\n    }\r\n","name":"Sentry","google":"","note":"Don't delete this file! It's used internally to help with page regeneration.","tagline":"sentry is dns for fun and profit!"}